---
title: "V8に初めてパッチを出すための手引き"
emoji: "✍️"
type: "tech"
topics: ["v8", "chromium", "git", "gerrit", "depot_tools"]
published: false
---

## はじめに

初めてV8にパッチを送ったのですが、公式ドキュメントだけでやるにはかなり難易度が高かったので、備忘録的に残しておきます。

### V8開発の基本ルール

まず、V8開発には特殊なルールがあります。

- **V8はGitHubではない**: GitHubにあるのはミラーであり、Pull Requestは送れません。**Gerrit**というレビューシステムで構築された[Chromiumリポジトリ](https://chromium.googlesource.com/v8/v8.git)にパッチを提出
- **Googleアカウントと物理キーが必須**: `commit` に使用するメールアドレスと**完全に一致するGoogleアカウント**、そしてそのアカウントに紐付けられた**物理的なFIDO2セキュリティキー**の所持が必須

> V8/Chromium開発で使われる関連サイト(Code Search, Gitiles, crbugなど)の詳しい使い分けについては、jxckさんのこちらの記事が非常に参考になります。
> [Chromium にコントリビュートするための周辺知識](https://blog.jxck.io/entries/2024-03-26/chromium-contribution.html)

## Step 1: 準備 - コードを手元に持ってくるまで

### 1. depot_toolsのインストール

Chromium/V8の開発には `depot_tools` というツール群が必須です。まずこれを `git clone` し、パスを通します。

```bash
git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
export PATH="$(pwd)/depot_tools:$PATH" # これは環境に合わせて設定してください
```

### 2. ソースコードの取得

`fetch` コマンドでV8のソースコード一式を取得します。巨大なリポジトリなので、かなりの時間がかかります。

```bash
fetch v8
```

実行したディレクトリ直下に `v8` ディレクトリが作成されるので、移動します。

```bash
cd v8
```

## Step 2: 開発と最初のコミット

### 1. 依存関係の更新とブランチ作成

開発を始める前に、まず依存関係を最新化しておきましょう。

```bash
gclient sync
```

完了したら、作業用のブランチを切ります。

```bash
git checkout -b fix/my-cool-fix
```

### 2. コード修正とAUTHORSファイルへの追記

ブランチを切ったら、コードを修正します。同時に、初めての貢献の場合はルートディレクトリにある `AUTHORS` ファイルに自分の名前とメールアドレスを追記する必要があります。これは `presubmit` チェックで要求されるため、最初のコミットに含めてしまいましょう。辞書順での記述が求められるので、自身の名前とメールアドレスを適切な箇所に追記します。

### 3. コミット

コードの変更と `AUTHORS` ファイルの変更をまとめてコミットします。

```bash
git add .
git commit
```

コミットメッセージはV8の規約に沿って記述する必要があります。基本的には `[component]: Short description` という形式です。例えば、以下のように記述します。

```txt
Fix various typos in comments

This patch fixes several spelling mistakes in comments across the codebase.
```

## Step 3: 認証とPresubmit (ここからが難関)

### 1. Gerritアカウント作成

ここからが難関です。まず[Gerrit](https://chromium-review.googlesource.com/)にアクセスし、コミットに使うGoogleアカウントでログインしてアカウントを作成します。（僕はこれを見落としててずっと認証できずに苦戦してました😅）

この手順を見落とすと、後々の認証プロセスで必ずつまずくため、非常に重要です。

### 2. CLA署名

初めてGoogleのOSSに貢献する場合、[CLA (Contributor License Agreement) 署名ページ](https://cla.developers.google.com/)から個人または法人向けの契約に署名が必要です。

### 3. 認証プロセス

次に認証を通します。各コマンドの役割を理解しておくとスムーズです。

```bash
# 1. まずはブラウザでGoogleアカウントにログインし、認証情報を作る
#    （ここでGoogleアカウントの2段階認証が求められ、物理キーの出番となる）
git credential-luci login

# 2. 認証が成功したか、Gitの設定が正しいかを確認する
git cl creds-check

# 3. (もし後日、認証が切れた場合) このコマンドで再認証を行う
git credential-luci reauth
```

`ReAuth successful!` と表示されれば成功です。

### 4. Presubmit実行

全ての準備が整ったら、`presubmit` チェックを実行します。これが通れば、アップロードの準備は完了です。

```bash
git cl presubmit
```

## Step 4: アップロード

### 1. レビュー担当者を探す

変更内容に関係するディレクトリにある `OWNERS` ファイルを確認し、適切なレビュー担当者を探します。

### 2. アップロード

担当者が見つかったら、`-r` オプションでその担当者のメールアドレスを指定してアップロードします。

```bash
git cl upload -r [コードオーナーのメールアドレスを指定]
```

これを実行するとVimが起動し、コミットメッセージの編集画面になります。内容を確認し、問題なければ `:wq` で保存して終了します。

```txt
remote: SUCCESS
remote:
remote:   https://chromium-review.googlesource.com/c/v8/v8/+/xxxxxxx Fix various typos in comments [NEW]
remote:
```

このURLが発行されれば、アップロードは完了です。

#### 補足: `upload` 時の便利なオプション

- **担当者を後で決めたい場合**: `-r` オプションなしで `git cl upload` を実行し、後からGerritのWeb UI上でレビュー担当者を追加することも可能
- **下書きとしてアップロードしたい場合**: いきなりレビューを依頼するのが不安な場合は、`git cl upload -d` (`--draft`) を使うと、自分だけが見える下書きとしてアップロード

## Step 5: アップロード後の流れと便利なコマンド

### 1. レビューの対応

アップロードが完了すると、Gerrit上でレビュー担当者からコメントが付きます。

- **修正**: 指摘された箇所をローカルで修正し、再度コミット
- **更新**: 同じブランチで、もう一度 `git cl upload` を実行
  - これにより、新しい「**Patchset**」としてレビューが更新

この繰り返しでパッチを完成させていきます。より詳しいレビューのやり取りについては、前述の[jxckさんの記事](https://blog.jxck.io/entries/2024-03-26/chromium-contribution.html)が非常に参考になります。

### 2. 便利なコマンド

開発・レビューサイクルで役立つコマンドです。

- **`git cl format`**: `git commit` する前に実行すると、Chromiumのコーディングスタイルに合わせて自動でソースコードを整形
- **`git cl issue`**: `upload` した後に、現在のブランチに紐付いているレビューページのURLをターミナルで再確認可能

## おわりに

V8への貢献は、コードそのものだけでなく、独自のツールチェーンと認証フローに慣れる必要があります。本記事が、これから挑戦する方々の助けになれば幸いです。
