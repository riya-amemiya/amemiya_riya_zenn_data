---
title: 'Nest x Fastify x Graphql x Prisma x Railway ã§APIã‚’ä½œã‚ã†'
emoji: 'ğŸ˜Š'
type: 'tech' # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['nestjs', 'fastify', 'graphql', 'prisma', 'railway']
published: true
---

## ã¯ã˜ã‚ã«

ä¿®æ­£ã‚„è¿½åŠ ç­‰ã¯ã‚³ãƒ¡ãƒ³ãƒˆã¾ãŸã¯GitHubã§ç·¨é›†ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãŠå¾…ã¡ã—ã¦ãŠã‚Šã¾ã™ã€‚

## Nest ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ

```bash
npx nest new [project-name]
```

## Nest ã« Fastify ã‚’å°å…¥ã™ã‚‹

```bash
yarn add -D @nestjs/platform-fastify
```

ã„ã‚‰ãªã„ã®ã§Expressã‚’å‰Šé™¤ã™ã‚‹ã€‚

```bash
yarn remove @nestjs/platform-express
```

main.tsã‚’ç·¨é›†ã™ã‚‹ã€‚

```diff typescript:main.ts
import { NestFactory } from '@nestjs/core';
+ import {
+     FastifyAdapter,
+     NestFastifyApplication,
+ } from '@nestjs/platform-fastify';
import { AppModule } from './app.module';

async function bootstrap() {
-    const app = await NestFactory.create(AppModule);
+    const app = await NestFactory.create<NestFastifyApplication>(
+        AppModule,
+        new FastifyAdapter(),
+    );
-    await app.listen(3000);
+    await app.listen(process.env.PORT || 3000, '0.0.0.0');
}

bootstrap();

```

## GraphQL ã®å°å…¥

```bash
yarn add @nestjs/graphql @nestjs/mercurius graphql mercurius fastify
```

app.module.tsã‚’ç·¨é›†ã™ã‚‹ã€‚

```diff typescript:app.module.ts
import { Module } from '@nestjs/common';
+ import { GraphQLModule } from '@nestjs/graphql';
+ import { MercuriusDriver, MercuriusDriverConfig } from '@nestjs/mercurius';
import { AppController } from './app.controller';
import { AppService } from './app.service';

@Module({
-    imports: [],
+    imports: [
+        GraphQLModule.forRoot<MercuriusDriverConfig>({
+            driver: MercuriusDriver,
+            graphiql: process.env.NODE_ENV !== 'production',
+            autoSchemaFile: true,
+            sortSchema: true,
+        }),
+    ],
    controllers: [AppController],
    providers: [AppService],
})
export class AppModule {}
```

## Prisma ã‚’å°å…¥ã™ã‚‹

```bash
yarn add prisma
```

Prismaã®åˆæœŸåŒ–ã‚’è¡Œã†ã€‚

```bash
npx prisma init
```

## PostgreSQL ã‚’å°å…¥ã™ã‚‹

https://railway.app?referralCode=_1ur3q

Railwayã§PostgreSQLã‚’ä½œæˆã™ã‚‹ã€‚

### Step

1. `New Project` ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹
2. å³ä¸Šã® `New` ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹
3. `Database` ã‚’é¸æŠã™ã‚‹
4. `PostgreSQL` ã‚’é¸æŠã™ã‚‹
5. `Connect` ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹
6. `Postgres Connection URL` ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹
7. `.env` ã« `DATABASE_URL` ã‚’è¿½åŠ ã™ã‚‹

```text:.env
DATABASE_URL="postgresql://..."
```

## DB ã‚’å®šç¾©ã™ã‚‹

schema.prismaã‚’ç·¨é›†ã™ã‚‹ã€‚

ç°¡å˜ãªä¾‹ã¨ã—ã¦ã€Userãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã™ã‚‹ã€‚

```diff text:schema.prisma
  // This is your Prisma schema file,
  // learn more about it in the docs: https://pris.ly/d/prisma-schema

  generator client {
    provider = "prisma-client-js"
  }

  datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
  }
+
+ model User {
+   id          String     @default(cuid()) @id
+   email       String     @unique
+   name        String?
+ }
```

## DB ã‚’ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹

```bash
npx prisma migrate dev
```

## Prisma Client ã‚’å°å…¥ã™ã‚‹

```bash
yarn add @prisma/client
```

prisma.service.tsã‚’ä½œæˆã™ã‚‹ã€‚

```bash
npx nest g s modules/prisma
```

```diff typescript:prisma.service.ts
- import { Injectable } from '@nestjs/common';
+ import { INestApplication, Injectable, OnModuleInit } from '@nestjs/common';
+ import { PrismaClient } from '@prisma/client';

@Injectable()
- export class PrismaService {}
+ export class PrismaService extends PrismaClient implements OnModuleInit {
+   async onModuleInit() {
+     await this.$connect();
+   }
+
+   async enableShutdownHooks(app: INestApplication) {
+     this.$on('beforeExit', async () => {
+       await app.close();
+     });
+   }
+ }
```

## GraphQL ã®å‹ã‚’ç”Ÿæˆã™ã‚‹

```bash
yarn add prisa-nestjs-graphql class-transformer
```

schema.prismaã‚’ç·¨é›†ã™ã‚‹ã€‚

```diff text:schema.prisma
  // This is your Prisma schema file,
  // learn more about it in the docs: https://pris.ly/d/prisma-schema

  generator client {
    provider = "prisma-client-js"
  }

+ generator nestgraphql {
+  provider = "prisma-nestjs-graphql"
+  output = "../src/@generated/prisma-nestjs-graphql"
+ }

  datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
  }

  model User {
    id          String     @default(cuid()) @id
    email       String     @unique
    name        String?
  }
```

gitignoreã‚’ç·¨é›†ã™ã‚‹ã€‚

```diff text:.gitignore
...
+ src/@generated
```

å‹ã‚’ç”Ÿæˆã™ã‚‹ã€‚

```bash
npx prisma generate
```

## Nest ã‹ã‚‰ GraphQL ã‚’å‘¼ã³å‡ºã›ã‚‹ã‚ˆã†ã«ã™ã‚‹

### Module ã¨ Resolver ã®ç”Ÿæˆ

```bash
npx nest g mo components/user
```

```bash
npx nest g r components/user
```

### PrismaService ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹

```diff typescript:user.module.ts
import { Module } from '@nestjs/common';
+ import { PrismaService } from 'src/prisma/prisma.service';
import { UserService } from './user.service';

@Module({
-   providers: [UserService],
    providers: [UserService, PrismaService],
})
export class UserModule {}
```

```diff typescript:user.resolver.ts
import { Resolver } from '@nestjs/graphql';
+ import { PrismaService } from 'src/prisma/prisma.service';

@Resolver()
export class UserResolver {
+   constructor(private prisma: PrismaService) {}
}
```

### Input ã¨ Output ã®å®šç¾©

```typescript:src/interfaces/user/user.model.ts
import { Field, InputType, ID, ObjectType } from '@nestjs/graphql';

@ObjectType()
export class User {
    @Field(() => ID, { nullable: false })
    id!: string;

    @Field(() => String, { nullable: false })
    email!: string;

    @Field(() => String, { nullable: true })
    name!: string | null;
}
```

```typescript:src/interfaces/user/user.input.ts
import { Field, InputType } from '@nestjs/graphql';

@InputType()
export class UserInput {
    @Field(() => String, { nullable: false })
    email!: string;

    @Field(() => String, { nullable: true })
    name?: string | null;
}
```

### Query ã®å®šç¾©

```typescript:user.resolver.ts
import { Args, Query, Resolver } from '@nestjs/graphql';
import { User } from 'src/interfaces/user/user.model';
import { PrismaService } from 'src/prisma/prisma.service';

@Resolver()
export class UserResolver {
    constructor(private prisma: PrismaService) {}

    @Query(() => [User])
    async getAllUsers() {
        return await this.prisma.user.findMany();
    }

    @Query(() => User)
    async getUserById(@Args('id') id: string) {
        return await this.prisma.user.findUnique({
            where: {
                id,
            },
        });
    }
}
```

### å‘¼ã³å‡ºã—ã¦ã¿ã‚‹

```bash
yarn start:dev
```

```bash
curl 'https://...' -H 'Accept-Encoding: gzip, deflate' -H 'Content-Type: application/json' -H 'Accept: application/json' -H 'Connection: keep-alive' -H 'Origin: chrome-extension://flnheeellpciglgpaodhkhmapeljopja' --data-binary '{"query":"{\n  getAllUser {\n    email\n    id\n    name\n  }\n}\n\n","variables":{}}' --compressed
```

## Railway ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹

https://railway.app?referralCode=_1ur3q

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®è¿½åŠ ã¯å‰è¿°ã—ãŸã®ã§ã€ã‚ã‚‹å‰æã§é€²ã‚ã¦ã„ãã¾ã™ã€‚

### Step

1. `PostgreSQL` ã‚’ä½œæˆã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã™ã‚‹
2. å³ä¸Šã® `New` ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹
3. `Empty Service` ã‚’é¸æŠã™ã‚‹
4. `Settings` ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹
5. `Deploy` é …ç›®ã® `Start Command` ã« `yarn start:prod` ã‚’å…¥åŠ›ã™ã‚‹
6. `Source Repo` ã‚’è¨­å®šã™ã‚‹
7. `Domains` ã® `Generate Domain` ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹

å¾Œã¯RailwayãŒè‡ªå‹•ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ãã‚Œã¾ã™ã€‚

## ã¾ã¨ã‚

Nest x Fastify x Graphql x Prisma x Railwayã§APIã‚’ä½œã£ã¦ã¿ã¾ã—ãŸã€‚
Railsã¨æ¯”ã¹ã¦ã€TypeScriptã®å‹ãŒã‚ã‚‹ã®ã§ã€é–‹ç™ºãŒæ¥½ã«ãªã‚Šã¾ã—ãŸã€‚
ã¾ãŸã€GraphQLã®å‹ã‚’ç”Ÿæˆã—ã¦ãã‚Œã‚‹ã®ã§ã€é–‹ç™ºåŠ¹ç‡ãŒä¸ŠãŒã‚Šã¾ã—ãŸã€‚
Railwayã¯ã€ãƒ‡ãƒ—ãƒ­ã‚¤ãŒç°¡å˜ã§ã€å€¤æ®µã‚‚å®‰ä¾¡ãªã®ã§ã€ä»Šå¾Œã‚‚ä½¿ã£ã¦ã„ããŸã„ã§ã™ã€‚

## Next.js ã§ GraphQL ã‚’å‘¼ã³å‡ºã™

https://zenn.dev/riya_amemiya/articles/6910d97b81e917
