---
title: "Vercelã®50MBåˆ¶é™ã¨ã®æˆ¦ã„"
emoji: "ğŸ•"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['vercel', 'next', 'nextauth', 'prisma']
published: true
---

## ã¯ã˜ã‚ã«

ä¿®æ­£ã‚„è¿½åŠ ç­‰ã¯ã‚³ãƒ¡ãƒ³ãƒˆã¾ãŸã¯GitHubã§ç·¨é›†ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãŠå¾…ã¡ã—ã¦ãŠã‚Šã¾ã™ã€‚

## å®Ÿè£…ç·¨

å…ˆæ—¥Vercelã§DBãŒä½¿ãˆã‚‹ã‚ˆã†ã«ãªã£ãŸã®ã§æ—©é€ŸNextã€Nextauthã€Prismaã§ã‚¢ãƒ—ãƒªé–‹ç™ºã‚’å§‹ã‚ã¾ã—ãŸã€‚
å…¬å¼ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒè±Šå¯Œãªã®ã§ã»ã¼ã‚¨ãƒ©ãƒ¼ãªã"ãƒ­ãƒ¼ã‚«ãƒ«"ã§å‹•ä½œã™ã‚‹ã‚¢ãƒ—ãƒªãŒå®Œæˆã—ã¾ã—ãŸã€‚
"ãƒ­ãƒ¼ã‚«ãƒ«ã§"ã€ãƒ­ãƒ¼ã‚«ãƒ«ã§ï¼

:::details Codeã‚’æ›¸ã

Vercelã§DBã‚’ç”¨æ„ã—ã¾ã™ã€‚

![](/images/67053888672aef/1.png)

æ±äº¬ã‹ã‚‰ã¯ã‚·ãƒ³ã‚¬ãƒãƒ¼ãƒ«ãŒ1ç•ªè¿‘ã„ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã§ã™ã€‚

å¿…è¦ãªç’°å¢ƒå¤‰æ•°ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚³ãƒ”ãƒšã—ã¾ã™ã€‚

![](/images/67053888672aef/2.png)

Prismaã®ã‚¹ã‚­ãƒ¼ãƒã‚’ç”¨æ„ã—ã¾ã™ã€‚

```prisma
generator client {
    provider = "prisma-client-js"
    encrypt  = true
}

datasource db {
    provider          = "postgresql"
    url               = env("POSTGRES_PRISMA_URL") // uses connection pooling
    directUrl         = env("POSTGRES_URL_NON_POOLING") // uses a direct connection
    shadowDatabaseUrl = env("POSTGRES_URL_NON_POOLING") // used for migrations
}

model Account {
    id                String  @id @default(cuid())
    userId            String
    type              String
    provider          String
    providerAccountId String
    refresh_token     String? @db.Text
    access_token      String? @db.Text
    expires_at        Int?
    token_type        String?
    scope             String?
    id_token          String? @db.Text
    session_state     String?

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([provider, providerAccountId])
}

model Session {
    id           String   @id @default(cuid())
    sessionToken String   @unique
    userId       String
    expires      DateTime
    user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
    id            String    @id @default(cuid())
    name          String?
    email         String?   @unique
    emailVerified DateTime?
    image         String?
    accounts      Account[]
    sessions      Session[]
}

model VerificationToken {
    identifier String
    token      String   @unique
    expires    DateTime

    @@unique([identifier, token])
}
```

ä»Šå›ã¯Googleã‚’ä½¿ã„ã€adapterã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦DBé€£æºã•ã›ã¾ã™ã€‚
ï¼ˆè©³ã—ã„è¨­å®šæ–¹æ³•ã¯é•·ããªã‚‹ã®ã§çœç•¥ï¼‰

```ts
import NextAuth, { type NextAuthOptions } from 'next-auth';
import {PrismaAdapter} from '@next-auth/prisma-adapter';
import {prisma} from '@/lib/prisma';
import type { NextApiRequest, NextApiResponse } from 'next/types';
import GoogleProvider from 'next-auth/providers/google';
export const authOptions: NextAuthOptions = {
  providers: [
    GoogleProvider( {
      clientId: process.env.GOOGLE_CLIENT_ID as string,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET as string,
    } ) ],
  adapter: PrismaAdapter( prisma ),
  pages: {
    signIn: '/login',
  },
  secret: process.env.NEXTAUTH_SECRET, // ã“ã‚ŒãŒãªã„ã¨æœ¬ç•ªã§ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹
  session: {
    strategy: "jwt", // middlewareã§sessionã‚’ä½¿ã†ãŸã‚ã«å¿…è¦
  },
}
const authHandler = ( req: NextApiRequest, res: NextApiResponse ) => NextAuth( req, res, authOptions );
export default authHandler
```

ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã‚’å…¬å¼ã‹ã‚‰ã‚³ãƒ”ãƒšã—ã¦ã¡ã‚‡ã£ã¨å¤‰ãˆã¾ã™ã€‚

```tsx
import { ClientSafeProvider, getProviders, signIn } from "next-auth/react";
import type {
 GetServerSidePropsContext,
 InferGetServerSidePropsType,
 NextPage,
} from "next/types";
import { getServerSession } from "next-auth/next";
import Layout from "@/components/Layout";
import { authOptions } from "./api/auth/[...nextauth]";
const Login: NextPage<{
 providers: InferGetServerSidePropsType<typeof getServerSideProps>;
}> = ({ providers }) => {
 return (
  <Layout title="ãƒ­ã‚°ã‚¤ãƒ³">
   {Object.values(providers).map((provider, index) => {
    return (
     <div key={index}>
      <button
       onClick={() =>
        signIn(provider?.id as unknown as ClientSafeProvider["id"])
       }
       type="button"
      >
       Sign in with{" "}
       {provider?.name as unknown as ClientSafeProvider["name"]}
      </button>
     </div>
    );
   })}
  </Layout>
 );
};

export default Login;
export async function getServerSideProps(context: GetServerSidePropsContext) {
 const session = await getServerSession(context.req, context.res, authOptions);
 if (session) {
  return { redirect: { destination: "/" } }; // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãªã‚‰ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
 }

 const providers = await getProviders();
 if (!providers) {
  return {
   notFound: true,
  };
 }

 return {
  props: { providers: providers },
 };
}
```

ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦å®Œæˆï¼ï¼ˆDBãŒé›¢ã‚Œã¦ã‚‹ã‹ã‚‰ã¡ã‚‡ã£ã¨ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã«æ™‚é–“ã‹ã‹ã‚‹ï¼‰

:::

## Vercelã«ãƒ‡ãƒ—ãƒ­ã‚¤

å‡ºæ¥ãŸã®ã§æ—©é€ŸVercelã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚
ã¨è¨€ã£ã¦ã‚‚ã½ã¡ã½ã¡ã—ã¦ã‚³ãƒ”ãƒšã™ã‚‹ã ã‘ã§ã™ã€‚

.envãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…¨éƒ¨ã‚³ãƒ”ãƒ¼ã—ã¦Keyã«ãƒšãƒ¼ã‚¹ãƒˆï¼ˆè‡ªå‹•ã§å…¥åŠ›ã•ã‚Œã¾ã™ï¼‰
é©å½“ãªå€¤ã«å¤‰æ›´ã—ã¦ã€deployãƒœã‚¿ãƒ³ï¾ï¾Ÿï¾ï¼

ã©ã†è€ƒãˆã¦ã‚‚å¼•ã£ã‹ã‹ã‚‹ã‚ã‘ãªã„50MBåˆ¶é™ã«å¼•ã£ã‹ã‹ã‚Šã¾ã—ãŸã€

![](/images/67053888672aef/3.png)

GitHubã«issueãŒã‚ã‚Šã¾ã™ã€‚

https://github.com/orgs/vercel/discussions/103

ã©ã†ã‚„ã‚‰Vercelå´ã®ãƒã‚°ï¼Ÿã‚‰ã—ã„ã€‚

next.config.jsã«ä»¥ä¸‹ã®è¨­å®šã‚’è¿½è¨˜ã—ã¾ã™ã€‚

```js next.config.js
/** @type {import('next').NextConfig} */
const nextConfig = {
 ...
 experimental: {
  ...
  outputFileTracingExcludes: {
   "*": [
    "node_modules/@swc/core-linux-x64-gnu",
    "node_modules/@swc/core-linux-x64-musl",
    "node_modules/@esbuild/linux-x64",
   ],
  },
 },
 ...
 },
};

module.exports = nextConfig;
```

deployï¼

ç„¡äº‹å‹•ãã¾ã—ãŸã€‚
Next13ã ã¨å‹•ã‹ãªã„ã¿ãŸã„ãªã‚³ãƒ¡ãƒ³ãƒˆã‚‚ã‚ã‚Šã¾ã—ãŸãŒã€æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã¯å‹•ä½œã—ã¾ã—ãŸã€‚

ãƒˆãƒ©ãƒƒãƒ—å¤šéãã„ï¼
