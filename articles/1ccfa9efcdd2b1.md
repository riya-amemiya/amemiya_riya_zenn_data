---
title: 'æ ¡å†…ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½œã£ãŸè©±'
emoji: 'âœ¨'
type: 'tech' # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['firebase', 'nextjs', 'typescript']
published: true
---

## ã¯ã˜ã‚ã«

ä¿®æ­£ã‚„è¿½åŠ ç­‰ã¯ã‚³ãƒ¡ãƒ³ãƒˆã¾ãŸã¯GitHubã§ç·¨é›†ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãŠå¾…ã¡ã—ã¦ãŠã‚Šã¾ã™ã€‚

é€šã£ã¦ã„ã‚‹å­¦æ ¡ã®ä¸ä¾¿ãªéƒ¨åˆ†ã‚’è‡ªä½œã‚·ã‚¹ãƒ†ãƒ ã§è§£æ±ºã—ãŸè©±ã§ã™ã€‚

## æœ¬é¡Œ

ç§ã¯ç¾åœ¨é€šä¿¡åˆ¶ã®å­¦æ ¡ã«é€šã£ã¦ã„ã¾ã™ã€‚
3å¹´ä»¥ä¸Šåœ¨ç±ã€74å˜ä½ä¿®äº†ã€ç‰¹åˆ¥æ´»å‹•ï¼ˆå­¦æ ¡ãŒç”¨æ„ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆï¼‰ã«ç´¯è¨ˆ30æ™‚é–“å‚åŠ ã™ã‚‹ã¨å’æ¥­ã§ãã¾ã™ã€‚
ãã‚“ãªå­¦æ ¡ã§ã™ãŒã€è‡ªåˆ†ãŒä½•å˜ä½ä¿®äº†ã—ãŸã®ã‹ã€ç‰¹åˆ¥æ´»å‹•ã¯ã‚ã¨ä½•æ™‚é–“å‚åŠ ã™ã‚Œã°ã„ã„ã®ã‹ã€ãªã©ã¯å…ˆç”Ÿã«ã„ã¡ã„ã¡ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚
ç”Ÿå¾’ã¨å…ˆç”Ÿã€ä¸¡è€…éå¸¸ã«ã‚ã‚“ã©ãã•ã„ã§ã™ã€‚
ãã“ã§ç„¡ã„ãªã‚‰ä½œã‚ã†ç²¾ç¥ã§æ ¡å†…ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½œã‚Šã¾ã—ãŸã€‚

## ä»•æ§˜

ã¨ã‚Šã‚ãˆãšã€ä»¥ä¸‹ã®ä»•æ§˜ã§æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚

- å¤–éƒ¨ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯é˜²ã
- å…ˆç”Ÿã¯å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç·¨é›†ã§ãã‚‹
- ç”Ÿå¾’ã¯è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ç·¨é›†ã§ãã‚‹
- ä¿®äº†å˜ä½æ•°ã‚„ç‰¹åˆ¥æ´»å‹•ã®å‚åŠ æ™‚é–“ã¯è‡ªå‹•ã§è¨ˆç®—ã•ã‚Œã‚‹
- ãƒ‡ãƒ¼ã‚¿ã¯ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚‚æ¶ˆãˆãªã„

ãƒ—ãƒ­ã‚°ãƒ©ãƒ å‘¨ã‚Šã¯[Firebase](https://firebase.google.com/)ã¨[Nextjs](https://nextjs.org/)ã‚’æ¡ç”¨ã—ã¾ã—ãŸã€‚
ç„¡ã„ã¨æ€ã„ã¾ã™ãŒã€DDoSå¯¾ç­–ã§[Cloudflare](https://www.cloudflare.com/)ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã¾ã™ã€‚

### å¤–éƒ¨ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯é˜²ã

ç§ã®å­¦æ ¡ã¯ç‹¬è‡ªãƒ‰ãƒ¡ã‚¤ãƒ³ã®Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒ1äºº1äººã«å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ã‚‹ã®ã§ã€ãã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§å¼¾ãã“ã¨ã«ã—ã¾ã—ãŸã€‚

### å…ˆç”Ÿã¯å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç·¨é›†ã§ãã‚‹

Cloud Firestoreã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã§åˆ¶å¾¡ã—ã¦ã„ã¾ã™ã€‚

```text
rules_version = '2';
service cloud.firestore {
  match /databases/{db}/documents {
   match /users/{userId} {
      allow read, update, delete: if request.auth != null && request.auth.uid == userId || get(/databases/$(db)/documents/users/$(request.auth.uid)).data.admin == true;
      allow create: if request.auth != null;
    }
  }
}
```

ç®¡ç†è€…(å…ˆç”Ÿ)ã«ã¯adminãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’trueã«ã—ã¦ã„ã¾ã™ã€‚

### ç”Ÿå¾’ã¯è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ç·¨é›†ã§ãã‚‹

Cloud Firestoreã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã§ã€uidã¨ä¸€è‡´ã™ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã¿é–²è¦§ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

### ä¿®äº†å˜ä½æ•°ã‚„ç‰¹åˆ¥æ´»å‹•ã®å‚åŠ æ™‚é–“ã¯è‡ªå‹•ã§è¨ˆç®—ã•ã‚Œã‚‹

Cloud Firestoreã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ãƒ•ãƒ­ãƒ³ãƒˆã§è¨ˆç®—ã—ã¦ã„ã¾ã™ã€‚

### ãƒ‡ãƒ¼ã‚¿ã¯ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚‚æ¶ˆãˆãªã„

`recoil-persist` ã‚’ä½¿ã£ã¦æ°¸ç¶šåŒ–ã—ã¦ã„ã¾ã™ã€‚

```typescript
import { atom } from 'recoil';
import { recoilPersist } from 'recoil-persist';

const { persistAtom } = recoilPersist();
export const userState = atom<{
    id: string;
    uid: string;
    displayName: string;
    email: string;
    admin: boolean;
    login: boolean;
    activeTime: string;
}>({
    key: 'user',
    default: {
        id: '',
        uid: '',
        displayName: '',
        email: '',
        admin: false,
        login: false,
        activeTime: '',
    },
    effects_UNSTABLE: [persistAtom],
    dangerouslyAllowMutability: true,
});
```

## å®Ÿè£…ç´¹ä»‹

### ãƒ­ã‚°ã‚¤ãƒ³

ãƒ­ã‚°ã‚¤ãƒ³ã¯Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§è¡Œã£ã¦ã„ã¾ã™ã€‚
ç™»éŒ²ã¨åŒæ™‚ã«è‡ªå‹•ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’Firestoreã«ä¿å­˜ã—ã¦ã„ã¾ã™ã€‚
Cloudflareã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½ã®ã›ã„ã§èª¤ã£ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’é¿ã‘ã‚‹ãŸã‚ã«ã€
tokenã‚’urlã«ä»˜ä¸ã—ã¦ã„ã¾ã™ã€‚
å¤–éƒ¨ã®äººã¯è‡ªå‹•ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

:::details LoginComponent

```tsx
import Button from '@mui/material/Button';
import {
    deleteUser,
    GoogleAuthProvider,
    signInWithPopup,
    signOut,
} from 'firebase/auth';
import {
    doc,
    getDoc,
    getFirestore,
    setDoc,
} from 'firebase/firestore';
import { NextRouter, useRouter } from 'next/router';
import { useAuthState } from 'react-firebase-hooks/auth';
import { SetterOrUpdater, useSetRecoilState } from 'recoil';
import { takingClassState } from '../atoms/takingClassState';
import { userState } from '../atoms/userState';
import { auth } from '../modules/FirebaseApp';
const Login = ({
    buttonCss,
    provider,
    setUserAtom,
    logOut,
    router,
}: {
    buttonCss?: string;
    provider: GoogleAuthProvider;
    setUserAtom: SetterOrUpdater<{
        id: string;
        uid: string;
        displayName: string;
        email: string;
        admin: boolean;
        login: boolean;
        activeTime: string;
    }>;
    logOut: (delet: boolean) => Promise<void>;
    router: NextRouter;
}) => {
    // ãƒãƒƒã‚·ãƒ¥åŒ–é–¢æ•°
    const cryptoText = async (text: string) => {
        const msgUint8 = new TextEncoder().encode(text);
        const hashBuffer = await crypto.subtle.digest(
            'SHA-256',
            msgUint8,
        );
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashHex = hashArray
            .map((b) => b.toString(16).padStart(2, '0'))
            .join('');
        return hashHex;
    };

    return (
        <Button
            className={buttonCss}
            variant="outlined"
            onClick={() => {
                // ãƒ­ã‚°ã‚¤ãƒ³
                signInWithPopup(auth, provider).then(
                    async (result) => {
                        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
                        const user = result.user;
                        /**
                         * ç”Ÿå¾’ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯XXYYY Nameã¨ã„ã†å½¢å¼ã«ãªã£ã¦ã„ã‚‹
                         * (XXã¯å…¥å­¦å¹´åº¦ã€YYYã¯ç•ªå·)
                         */
                        const idAndName = user.displayName?.match(
                            /([0-9]+)([^0-9]+)/,
                        );

                        const db = getFirestore();
                        const dbRef = doc(db, `users`, user.uid);
                        const querySnapshot = await getDoc(dbRef);
                        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã‚ã‚‹ã‹ç¢ºèª
                        if (querySnapshot.exists()) {
                            // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã‚ã‚‹å ´åˆã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æƒ…å ±ã‚’å–å¾—
                            const data = querySnapshot.data();
                            setUserAtom({
                                displayName: data.userName,
                                email: data.email,
                                id: data.userId,
                                uid: user?.uid,
                                admin: data.admin,
                                login: true,
                                activeTime: data?.activeTime || '0',
                            });
                        } else if (idAndName) {
                            // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ãªã„å ´åˆã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ç™»éŒ²
                            setUserAtom({
                                displayName: idAndName[2],
                                email: user?.email || '',
                                id: idAndName[1],
                                uid: user?.uid,
                                admin: false,
                                login: true,
                                activeTime: '0',
                            });
                            await setDoc(dbRef, {
                                userName: idAndName[2],
                                email: user?.email || '',
                                userId: idAndName[1],
                                admin: false,
                                activeTime: '0',
                                takingClass: '',
                                year: `${idAndName[1][0]}${idAndName[1][1]}`,
                                uid: user?.uid || '',
                            });
                        } else if (
                            /^.*?@(std\.)?hoge\.ac\.jp/.test(
                                user?.email || '',
                            )
                        ) {
                            // ã©ã®æ¡ä»¶ã«ã‚‚å½“ã¦ã¯ã¾ã‚‰ãªã„ãŒæ ¡å†…ã®äººãªã®ã§ä»®ç™»éŒ²
                            setUserAtom({
                                displayName: user?.displayName || '',
                                email: user?.email || '',
                                id: '0',
                                uid: user?.uid,
                                admin: false,
                                login: true,
                                activeTime: '0',
                            });
                        } else {
                            // å¤–éƒ¨ã®äººãªã®ã§ãƒ­ã‚°ã‚¤ãƒ³ã‚’æ‹’å¦
                            alert(
                                'å­¦æ ¡ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„',
                            );
                            logOut(true).then(() => {
                                router.replace(`/`);
                                router.reload();
                            });
                        }
                        cryptoText(user.uid).then((uid) => {
                            router.replace(`/?token=${uid}`);
                        });
                    },
                );
            }}>
            ãƒ­ã‚°ã‚¤ãƒ³
        </Button>
    );
};
export const LoginComponent = ({
    buttonCss,
}: {
    buttonCss?: string;
}) => {
    const provider = new GoogleAuthProvider();
    // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’å–å¾—
    const [user, loading, _error] = useAuthState(auth);
    const userUid = user?.uid || '';
    const setUserAtom = useSetRecoilState(userState);
    const setTakingClass = useSetRecoilState(takingClassState);
    const router = useRouter();
    const logOut = async (delet: boolean) => {
        if (delet && auth.currentUser) {
            deleteUser(auth.currentUser);
        }
        signOut(auth);
        setUserAtom({
            displayName: '',
            email: '',
            id: '',
            admin: false,
            uid: '',
            login: false,
            activeTime: '0',
        });
        setTakingClass({
            value: [],
            indexs: [],
            count: 0,
        });
    };

    if (loading) {
        return <div>Loading...</div>;
    }
    if (!user) {
        return (
            <Login
                buttonCss={buttonCss}
                provider={provider}
                setUserAtom={setUserAtom}
                logOut={logOut}
                router={router}
            />
        );
    }
    return (
        <>
            <Button
                className={buttonCss}
                variant="outlined"
                onClick={() => {
                    logOut(false).then(() => {
                        router.replace(`/`);
                    });
                }}>
                ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
            </Button>
        </>
    );
};
```

:::

### ç§‘ç›®ç®¡ç†

ç§‘ç›®ã¯å†…éƒ¨ã§ä¸‹è¨˜ã®ã‚ˆã†ã«ç®¡ç†ã—ã¦ã„ã¾ã™ã€‚

```typescript
// ç§‘ç›®ã®æƒ…å ±
// value:ç§‘ç›®å:å˜ä½æ•°
// label:ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¡¨ç¤ºã•ã‚Œã‚‹ç§‘ç›®å
const japanese = [
    {
        value: 'å›½èªç·åˆ:4',
        label: 'å›½èªç·åˆ',
    },
    {
        value: 'å›½èªè¡¨ç¾:3',
        label: 'å›½èªè¡¨ç¾',
    },
    {
        value: 'ç¾ä»£æ–‡A:2',
        label: 'ç¾ä»£æ–‡A',
    },
    {
        value: 'å¤å…¸A:2',
        label: 'å¤å…¸A',
    },
];
const english = [
    {
        value: 'ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³è‹±èª1:3',
        label: 'ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³è‹±èª1',
    },
    {
        value: 'ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³è‹±èª2:4',
        label: 'ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³è‹±èª2',
    },
    {
        value: 'è‹±èªè¡¨ç¾1:2',
        label: 'è‹±èªè¡¨ç¾1',
    },
    {
        value: 'è‹±èªè¡¨ç¾2:4',
        label: 'è‹±èªè¡¨ç¾2',
    },
];
export const subjects = [...japanese, ...english].map(
    (item, index) => {
        return { ...item, index };
    },
);
```

:::details SlectComponent

```tsx
import Select from 'react-select';
import { useRecoilState } from 'recoil';
import { takingClassState } from '../../atoms/takingClassState';

const SlectComponent = ({
    subjects,
}: {
    subjects: {
        value: string;
        label: string;
        index: number;
    }[];
}) => {
    const [takingClass, setTakingClass] = useRecoilState(
        takingClassState,
    );
    return (
        <Select
            className="text-black"
            // ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰
            defaultValue={takingClass.indexs.map((n) => subjects[n])}
            onChange={(e) => {
                // ç§‘ç›®ã¯å†…éƒ¨ã§ã€ç§‘ç›®å:å˜ä½æ•°ã€ã¨ã„ã†å½¢å¼ã§ç®¡ç†ã—ã¦ã„ã‚‹
                const value = e.map((v) => v.value.split(':'));
                const indexs = e.map((v) => v.index);
                // å˜ä½æ•°ã®åˆè¨ˆã‚’è¨ˆç®—
                let count = 0;
                value.forEach((v) => {
                    count += Number(v[1]);
                });
                setTakingClass({
                    value,
                    indexs,
                    count,
                });
            }}
            options={subjects}
            isClearable={true}
            isSearchable={true}
            isMulti={true}
        />
    );
};
export default SlectComponent;
```

:::

### ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½

ç°¡æ˜“çš„ãªã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½ã§ã™ã€‚
åˆ©ç”¨ã™ã‚‹éš›ã¯filterã§æ¤œç´¢ã—ã¾ã™ã€‚

```typescript
import { useRecoilState } from 'recoil';
import { cacheState } from '../../atoms/cacheState';
import { userState } from '../atoms/userState';

const [cache, setCache] = useRecoilState(cacheState);
const user = useRecoilValue(userState);

// ã‚­ãƒ£ãƒƒã‚·ãƒ¥å–å¾—
const getCache = cache.filter((n) => {
    return n.id === user.uid;
});

// ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
setCache([
    ...cache,
    {
        id: user.uid,
        data: user,
    },
]);
```

:::details cacheState

```typescript
import { atom } from 'recoil';
import { recoilPersist } from 'recoil-persist';

const { persistAtom } = recoilPersist();
export const cacheState = atom<
    {
        id: string;
        data: any;
    }[]
>({
    key: 'cache',
    default: [],
    effects_UNSTABLE: [persistAtom],
    dangerouslyAllowMutability: true,
});
```

:::

### ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã¨èª­ã¿è¾¼ã¿

takingClassStateã¨ã„ã†atomã«ç§‘ç›®ã®æƒ…å ±ã‚’ä¿å­˜ã—ã¦ã„ã¾ã™ã€‚
takingClassStateã«ã¯ `0,1,2` ã®ã‚ˆã†ãªæ•°å­—ã®ç¾…åˆ—ãŒæ–‡å­—åˆ—ã§æ ¼ç´ã•ã‚Œã¦ã„ã¾ã™ã€‚
ã“ã‚Œã¯ç§‘ç›®ä¸€è¦§é…åˆ—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§ã€ã“ã‚Œã‚’å…ƒã«ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¦ã„ã¾ã™ã€‚

:::details DataSaveAndLoad

```tsx
import { Button } from '@mui/material';
import {
    doc,
    getDoc,
    getFirestore,
    setDoc,
    updateDoc,
} from 'firebase/firestore';
import { SetterOrUpdater, useRecoilState } from 'recoil';
import { cacheState } from '../../atoms/cacheState';
import loadTakingClass from '../../lib/loadTakingClass';

const NotAdminComponent = ({
    user,
    takingClass,
    setTakingClass,
}: {
    user: {
        id: string;
        uid: string;
        displayName: string;
        email: string;
        admin: boolean;
        login: boolean;
    };
    takingClass: {
        value: string[][];
        indexs: number[];
        count: number;
    };
    setTakingClass: SetterOrUpdater<{
        value: string[][];
        indexs: number[];
        count: number;
    }>;
}) => {
    // Firebaseã®ç„¡æ–™æ ã®ä¸Šé™ã«å¼•ã£ã‹ã‹ã‚‰ãªã„ã‚ˆã†ã«ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ã†
    const [cache, setCache] = useRecoilState(cacheState);
    return (
        <>
            <div className="flex">
                <div className="w-32">
                    <Button
                        className="w-full"
                        variant="outlined"
                        onClick={async () => {
                            const getCache = cache.filter((n) => {
                                return n.id === user.uid;
                            });
                            const takingClassData =
                                takingClass.indexs.length > 0
                                    ? takingClass.indexs.join(',')
                                    : '';

                            if (!user.admin) {
                                // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒãªã„ã‹ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒå¤ã„å ´åˆã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                                if (
                                    getCache.length === 0 ||
                                    getCache[0].data.takingClass !==
                                        takingClassData
                                ) {
                                    const db = getFirestore();
                                    const dbRef = doc(
                                        db,
                                        `users`,
                                        user.uid,
                                    );
                                    const querySnapshot = await getDoc(
                                        dbRef,
                                    );
                                    if (querySnapshot.exists()) {
                                        await updateDoc(dbRef, {
                                            takingClass: takingClassData,
                                        });
                                    } else {
                                        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ã€ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
                                        await setDoc(
                                            dbRef,
                                            {
                                                userName:
                                                    user?.displayName ||
                                                    '',
                                                userId:
                                                    user?.id || '',
                                                email:
                                                    user?.email || '',
                                                takingClass: takingClassData,
                                                admin:
                                                    user?.admin ||
                                                    false,
                                                year: `${user?.id[0]}${user?.id[1]}`,
                                                uid: user?.uid || '',
                                                activeTime: 0,
                                            },
                                            { merge: true },
                                        );
                                    }
                                    const getCache = [
                                        cache.filter((n) => {
                                            return n.id === user.uid;
                                        }),
                                        cache.filter((n) => {
                                            return n.id !== user.uid;
                                        }),
                                    ];
                                    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ›´æ–°
                                    if (getCache[0].length !== 0) {
                                        getCache[0][0].data.takingClass = takingClassData;
                                        setCache([
                                            ...getCache[0],
                                            ...getCache[1],
                                        ]);
                                    } else {
                                        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒãªã„å ´åˆã¯ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½œæˆ
                                        setCache([
                                            ...cache,
                                            {
                                                id: user.uid,
                                                data: {
                                                    ...user,
                                                    takingClass: takingClassData,
                                                },
                                            },
                                        ]);
                                    }
                                }
                            }
                        }}>
                        ä¿å­˜
                    </Button>
                </div>
                <div className="w-32">
                    <Button
                        className="w-full"
                        variant="outlined"
                        onClick={async () => {
                            if (!user.admin) {
                                // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å–å¾—
                                const getCache = cache.filter((n) => {
                                    return n.id === user.uid;
                                });
                                if (getCache.length !== 0) {
                                    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚‹å ´åˆã¯ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                                    if (
                                        getCache[0].data?.takingClass
                                    ) {
                                        loadTakingClass({
                                            setTakingClass,
                                            takingClass:
                                                getCache[0].data
                                                    .takingClass,
                                        });
                                    }
                                } else {
                                    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒãªã„å ´åˆã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                                    const data = await getDoc(
                                        doc(
                                            getFirestore(),
                                            'users',
                                            user.uid,
                                        ),
                                    );
                                    if (data.exists()) {
                                        const user = data.data();
                                        if (user.takingClass) {
                                            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½œæˆ
                                            setCache([
                                                ...cache,
                                                {
                                                    id: user.uid,
                                                    data: user,
                                                },
                                            ]);
                                            // ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                                            loadTakingClass({
                                                setTakingClass,
                                                takingClass:
                                                    user.takingClass,
                                            });
                                        }
                                    }
                                }
                            }
                        }}>
                        èª­ã¿è¾¼ã¿
                    </Button>
                </div>
            </div>
        </>
    );
};
export default NotAdminComponent;
```

:::

### AppCheck ã®å°å…¥

AppCheckã¯ã€FirebaseãŒæä¾›ã—ã¦ã„ã‚‹æ©Ÿèƒ½ã§ã€ã‚¢ãƒ—ãƒªã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å¼·åŒ–ã™ã‚‹ãŸã‚ã®æ©Ÿèƒ½ã§ã™ã€‚

ä¸‹è¨˜ã®ã‚³ãƒ¼ãƒ‰ã‚’ç”¨æ„ã—ã¾ã™ã€‚

```typescript
import { initializeApp } from 'firebase/app';
import {
    getToken,
    initializeAppCheck,
    ReCaptchaV3Provider,
} from 'firebase/app-check';
import { getAuth } from 'firebase/auth';
const firebaseConfig = {
    ...
};
export const app = initializeApp(firebaseConfig);

export const auth = getAuth(app);
declare global {
    var FIREBASE_APPCHECK_DEBUG_TOKEN: boolean | string | undefined;
}
if (typeof document !== 'undefined') {
    if (process.env.NODE_ENV === 'development') {
        window.self.FIREBASE_APPCHECK_DEBUG_TOKEN = true;
    }
    const appCheck = initializeAppCheck(app, {
        provider: new ReCaptchaV3Provider(
            process.env.NEXT_PUBLIC_RECAPTCHAV3_SITE_KEY || '',
        ),
        isTokenAutoRefreshEnabled: true,
    });
    getToken(appCheck)
        .then(() => {
            console.log('AppCheck:Success');
        })
        .catch((error) => {
            console.log(error.message);
        });
}
```

`_app.tsx` ã«ã¦ã€`AppCheck` ã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚

```tsx:_app.tsx
import '../modules/FirebaseApp';
```

## ãã®ä»–å°æŠ€

### SSR å›é¿

ãƒšãƒ¼ã‚¸ã‚’å‹•çš„ã«ä½œæˆã™ã‚‹é–¢ä¿‚ã§ã€SSRãŒã§ããªã„ãŸã‚ã€SSRã‚’ç„¡åŠ¹ã«ã—ã¦ã„ã¾ã™ã€‚

```tsx
const Layout = dynamic(() => import('../components/Layout'), {
    ssr: false,
});
```

### æ¤œç´¢æ™‚ã®ã‚¨ãƒ©ãƒ¼å‡¦ç†

å…ˆç”Ÿå´ã§ç”Ÿå¾’æ¤œç´¢ã‚’ã‹ã‘ã‚‹éš›ã«ä¸æ­£ãªãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã•ã‚ŒãŸå ´åˆã®å‡¦ç†ã§ã™ã€‚

```tsx
import TextField from '@mui/material/TextField';
import { useState } from 'react';
import { useRecoilState } from 'recoil';
import { isNumber } from 'umt/module/Math/isNumber';
import { studentState } from '../atoms/studentState';
export const SearchStudentComponent = ({
    children,
}: {
    children: React.ReactNode;
}) => {
    const [student, setStudent] = useRecoilState(studentState);
    const [error, setError] = useState('');
    return (
        <>
            <TextField
                type="text"
                label="å­¦ç±ç•ªå·æ¤œç´¢"
                className="bg-white border-black border-b"
                onChange={(e) => {
                    if (
                        isNumber(e.target.value) &&
                        e.target.value.length <= 5
                    ) {
                        setStudent({
                            ...student,
                            id: e.target.value,
                        });
                    }
                    // ãƒ‡ãƒ¼ã‚¿ãƒã‚§ãƒƒã‚¯
                    if (e.target.validity.valid) {
                        setError('');
                    } else {
                        setError(e.target.validationMessage);
                    }
                }}
                // å…¥åŠ›ã§ãã‚‹æ–‡å­—æ•°ã‚’åˆ¶é™
                inputProps={{ minLength: 5, maxLength: 5 }}
                value={student.id}
            />
            {/* ã‚¨ãƒ©ãƒ¼ç¢ºèª */}
            {error ? <div>{error}</div> : { children }}
        </>
    );
};
```

## é–‹ç™ºç§˜è©±

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¸¸ã”ã¨å¤‰æ›´äº‹ä»¶

ã“ã®ãƒã‚°ã®ã›ã„ã§2æ™‚é–“ã»ã©ç„¡é§„ã«ã—ã¾ã—ãŸã€‚
æœªã ã«åŸå› ãŒã‚ã‹ã£ã¦ã„ã¾ã›ã‚“ã€‚
Realtime Databaseã¯æœ¬ç•ªç’°å¢ƒã ã¨ãªãœã‹ç„¡é™ãƒ«ãƒ¼ãƒ—ãŒç™ºç”Ÿã—ã¦ä½¿ãˆãªã„ãƒã‚°ãŒã‚ã‚Šã¾ã—ãŸã€‚
Nodeã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’12.Xã¾ã§ä¸‹ã’ã‚Œã°è§£æ±ºã™ã‚‹ã¨ã„ã†è¨˜äº‹ã‚‚ã‚ã‚Šã¾ã—ãŸãŒã€
ãã‚“ãªå¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã¯ä»–ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒå‹•ã‹ãªã„ã®ã§ã€Cloud Firestoreã«æ€¥é½å¤‰æ›´ã›ã–ã‚‹ã‚’å¾—ã¾ã›ã‚“ã§ã—ãŸã€‚

### èª­ã¿å–ã‚Šå›æ•°å¤šã™ãäº‹ä»¶

ãƒªãƒªãƒ¼ã‚¹åˆæ—¥ã«1ä¸‡å›ã‚‚èª­ã¿å–ã‚ŠãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚
1æ—¥ã®ä¸Šé™ã¯2ä¸‡å›ãªã®ã§å±ãªã‹ã£ãŸã§ã™ã€‚
ç§ã®å­¦æ ¡ã¯å…¨æ ¡ç”Ÿå¾’100äººã»ã©ãªã®ã«ã€ç§ã®å®Ÿè£…ãŒæ‚ªãã€èª­ã¿å–ã‚Šå›æ•°ãŒç•°å¸¸ã«å¤šããªã£ã¦ã—ã¾ã„ã¾ã—ãŸã€‚
ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½ã‚’å°å…¥ã—ãŸã“ã¨ã«ã‚ˆã‚Šã€èª­ã¿å–ã‚Šå›æ•°ã¯å¤§å¹…ã«æ¸›ã‚Šã¾ã—ãŸã€‚(ç´„1ä¸‡â†’ç´„200å›)
é›‘ãªå®Ÿè£…ã¯æ‚ªã§ã™ã­ã€‚
Don't write bad code.

### åŸå› ãƒã‚«ã™ãAppCheckäº‹ä»¶

AppCheckã¯reCAPTCHAã§èªè¨¼ã™ã‚‹ã®ã§ã™ãŒã€ãªãœã‹ã‚¨ãƒ©ãƒ¼ã§èªè¨¼ã§ããªã„ã¨ã„ã†ãƒã‚°ãŒã‚ã‚Šã¾ã—ãŸã€‚
ã“ã‚Œã¯ã‚µã‚¤ãƒˆã‚­ãƒ¼ã®æœ€å¾Œã®ä¸€æ–‡å­—ãŒä½•æ•…ã‹æ¬ è½ã—ã¦ã„ãŸã®ãŒåŸå› ã§ã—ãŸã€‚
ãƒã‚«ã™ãã§ã™ã­ã€‚

### Text content does not match server-rendered HTMLäº‹ä»¶

ã“ã‚Œã‚‚ç§ã®å®Ÿè£…ãŒæ‚ªã‹ã£ãŸã›ã„ã§ç™ºç”Ÿã—ãŸãƒã‚°ã§ã™ã€‚

```text
Unhandled Runtime Error
Error: Text content does not match server-rendered HTML.

è¨³: ã‚µãƒ¼ãƒãƒ¼å´ã§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚ŒãŸHTMLã¨ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒä¸€è‡´ã—ãªã„ãã‚¢ãƒ›ã€‚
```

ãƒ•ãƒ­ãƒ³ãƒˆå´ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’åˆ¤å®šã—ã¦ã„ã‚‹ã®ã§ã€
ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚ŒãŸéš›ã«HTMLãŒå¤‰ã‚ã£ã¦ã—ã¾ã„ã€ã“ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã¾ã—ãŸã€‚
suppressHydrationWarningã‚’ä½¿ã£ã¦å›é¿ã§ãã‚‹ã‚‰ã—ã„ã§ã™ãŒã€çµå±€ç®‡æ‰€ã‚’ç‰¹å®šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚
ä»•æ–¹ãªãSSRã‚’ç„¡åŠ¹ã«ã—ã¦è§£æ±ºã—ã¾ã—ãŸã€‚(Nextjsã®æ©æµã‚’æ¨ã¦ã¦ã‚‹ã‚ˆã†ãªæ°—ãŒã—ã¾ã™ãŒã—ã‚‡ã†ãŒãªã„)

## ã¾ã¨ã‚

ä»¥ä¸Šã€æ ¡å†…ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½œã£ãŸè©±ã§ã—ãŸã€‚
1æ—¥ã‚‚ã‹ã‹ã‚‰ãšã«ä½œã‚ŒãŸã®ã¯ã€Firebaseã®ãŠã‹ã’ã§ã™ã€‚(ã‚ã‚ŠãŒãŸã‚„ã€œğŸ™)
å§‹ã‚ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã—ã§ã®å®Ÿè£…ã ã£ãŸã®ã§ã™ãŒã€äºˆæƒ³ä»¥ä¸Šã«èª­ã¿å–ã‚Šå›æ•°ãŒå¤šã‹ã£ãŸã®ã§æ€¥é½ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å°å…¥ã—ã¾ã—ãŸã€‚
ã ã„ã¶é›‘ãªå®Ÿè£…ã§ã™ãŒã€æœ€ä½é™ã®æ©Ÿèƒ½ã¯å®Ÿè£…ã§ãã¦ã„ã‚‹ã®ã§ã€ã¾ã‚ã„ã„ã‹ãªã¨æ€ã£ã¦ã„ã¾ã™ã€‚
(æ ¡å†…ã§å…ˆç”Ÿå«ã‚Next.jsã‚’æ‰±ãˆã‚‹äººã¯ç§ã—ã‹ã„ãªã„ã®ã§ã€ä¿å®ˆãŒæ¬¡ã®èª²é¡Œã§ã™ã€‚)

## ãƒªãƒ³ã‚¯

ä½¿ç”¨ã—ãŸã‚‚ã®ã§ã™ã€‚

- [Firebase](https://firebase.google.com/)
- [Next.js](https://nextjs.org/)
- [Cloudflare](https://www.cloudflare.com/)
- [Recoil](https://recoiljs.org/)
- [Material-UI](https://mui.com/)
- [Tailwind CSS](https://tailwindcss.com/)
- [UMT](https://github.com/riya-amemiya/UMT)

## ãŠã¾ã‘

### è‡ªä½œãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« UMT ã®åˆ©ç”¨

ä»Šå›ã¯ä¸‹è¨˜ã®æ©Ÿèƒ½ã®ã¿ã‚’åˆ©ç”¨ã—ã¾ã—ãŸã€‚
[UMT](https://github.com/riya-amemiya/UMT)ã¯ã€è‡ªä½œã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ã™ã€‚
ã€Œã„ã¤ã‹ä½¿ã†ã‹ã‚‚ã—ã‚Œãªã„ã€ãã‚‰ã„ã®é »åº¦ã§ä½¿ã‚ã‚Œã‚‹ã‚ˆã†ãªæ©Ÿèƒ½ã‚’ã¾ã¨ã‚ã¦ã„ã¾ã™ã€‚

#### æ•°å€¤åˆ¤å®š

```typescript
/* isNumber(æ–‡å­—åˆ— or æ•°å€¤, æ–‡å­—åˆ—ã‚‚è¨±å¯ã™ã‚‹ã‹ã©ã†ã‹)
 * æ•°å€¤å‹ã«å¤‰æ›å¯èƒ½ãªå ´åˆã¯ true ã‚’è¿”ã™
 */
import { isNumber } from 'umt/module/Math/isNumber';
console.log(isNumber('123')); // true
console.log(isNumber('123a')); // false
console.log(isNumber('123', false)); // false
```
