---
title: "ChatGPTã§æ­£è¦è¡¨ç¾ã‚’è‡ªå‹•ç”Ÿæˆã—ã‚ˆã†"
emoji: "ğŸ‘‹"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['chatgpt', 'gpt3', 'regex',"openai"]
published: true
---

## ã¯ã˜ã‚ã«

ä¿®æ­£ã‚„è¿½åŠ ç­‰ã¯ã‚³ãƒ¡ãƒ³ãƒˆã¾ãŸã¯GitHubã§ç·¨é›†ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãŠå¾…ã¡ã—ã¦ãŠã‚Šã¾ã™ã€‚

## å®Ÿè£…ç·¨

æœ€è¿‘è©±é¡Œã®Function callingã§æ­£è¦è¡¨ç¾ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

https://openai.com/blog/function-calling-and-other-api-updates

### é–¢æ•°ã‚’å®šç¾©ã™ã‚‹

é–¢æ•°ã®èª¬æ˜ã‚’æ›¸ãã¾ã™ã€‚é–¢æ•°ã®åå‰ã€èª¬æ˜ã€ä»•æ§˜ã€å¼•æ•°ã®åå‰ã¨å½¹å‰²ãªã©
`functions` ã®typeã«ã¯ã€jsonschemaã®å®šç¾©ã‚’æ›¸ãã¾ã™ã€‚

```python
functions = [
    {
        "name": "check_regex",
        "description": "æ­£è¦è¡¨ç¾ãŒæ­£ã—ã„ã‹ã©ã†ã‹ã‚’åˆ¤å®šã™ã‚‹é–¢æ•°ã€‚æˆ»ã‚Šå€¤ãŒTrueã®å ´åˆã¯æ­£è¦è¡¨ç¾ã¯æ­£ã—ã„ã¨åˆ¤æ–­ã™ã‚‹ã€Falseã®å ´åˆã¯æ­£ã—ããªã„ã¨åˆ¤æ–­ã™ã‚‹ã€‚",
        "parameters": {
            "type": "object",
            "properties": {
                "regex": {
                    "type": "string",
                    "description": "æ­£è¦è¡¨ç¾",
                },
                "test_strs": {
                    "type": "array",
                    "items": {"type": "string"},
                    "description": "ãƒ†ã‚¹ãƒˆã™ã‚‹æ–‡å­—åˆ—ã®é…åˆ—",
                },
                "result_with_test_strs": {
                    "type": "array",
                    "items": {"type": "boolean"},
                    "description": "ãƒ†ã‚¹ãƒˆã™ã‚‹æ–‡å­—åˆ—ã«å¯¾ã™ã‚‹æ¨å®šã—ã¦ã„ã‚‹çµæœã®é…åˆ—",
                },
            },
            "required": ["regex", "test_strs", "result_with_test_strs"],
        },
    }
]

# ä¸Šã§å®šç¾©ã—ãŸé–¢æ•°ã‚’å®Ÿè£…ã™ã‚‹

def check_regex(regex, test_strs, result_with_test_strs):
    import re
    result = []
    for test_str in test_strs:
        if re.match(regex, test_str):
            result.append(True)
        else:
            result.append(False)
    return result == result_with_test_strs
```

### ChatGPTã§æ­£è¦è¡¨ç¾ã‚’ç”Ÿæˆã™ã‚‹

æˆåŠŸã™ã‚‹ã¾ã§ç¹°ã‚Šè¿”ã—ã¾ã™ã€‚

```python
import openai
from dotenv import load_dotenv
import os
import json

load_dotenv()
openai.api_key = os.getenv("OPENAI_API_KEY")
messages = []
flag = True
model_name = "gpt-3.5-turbo-0613"
try:
    while True:
        if flag:
            question = input(">> ")
            if question == "exit":
                break
            messages.append({"role": "user", "content": question})
        else:
            flag = True
        responses = openai.ChatCompletion.create(
            model=model_name,
            messages=messages,
            # ã“ã“ã§é–¢æ•°ã‚’å®šç¾©ã—ãŸé…åˆ—ã‚’æ¸¡ã™
            functions=functions,
            # autoã«ã™ã‚‹ã¨è‡ªå‹•ã§é–¢æ•°ã‚’å‘¼ã¶ã‹ã©ã†ã‹ã‚’åˆ¤æ–­ã—ã¦ãã‚Œã‚‹
            function_call="auto",
        )
        message_tmp = responses["choices"][0]["message"]
        # function_callãŒã‚ã‚‹å ´åˆã¯é–¢æ•°ã‚’å‘¼ã³å‡ºã™
        if message_tmp.get("function_call"):
            try:
                arguments = json.loads(message_tmp["function_call"]["arguments"])
            except json.decoder.JSONDecodeError:
                flag = False
                continue
            # é–¢æ•°ã‚’å‘¼ã³å‡ºã™
            function_response = check_regex(
                regex=arguments["regex"],
                test_strs=arguments["test_strs"],
                result_with_test_strs=arguments["result_with_test_strs"],
            )
            if function_response:
                print(
                    arguments["regex"],
                    arguments["test_strs"],
                    arguments["result_with_test_strs"],
                )
                flag = True
            # é–¢æ•°ã®æˆ»ã‚Šå€¤ã‚’è¿½åŠ ã™ã‚‹
            messages.append(
                {
                    "role": "function",
                    "name": message_tmp["function_call"]["name"],
                    # é–¢æ•°ã®æˆ»ã‚Šå€¤ã¯strã«å¤‰æ›ã™ã‚‹
                    "content": str(function_response),
                }
            )

            if not function_response:
                messages.append(
                    {
                        "role": "user",
                        "content": "æ­£è¦è¡¨ç¾ãŒé–“é•ã£ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚ã‚‚ã†ä¸€åº¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚",
                    }
                )
                flag = False
        else:
            messages.append({"role": "assistant", "content": message_tmp["content"]})
            messages.append({"role": "user", "content": "testã—ã¦"})
            flag = False
except KeyboardInterrupt:
    pass
```

### ã‚³ãƒ¼ãƒ‰å…¨æ–‡

```python
import openai
from dotenv import load_dotenv
import os
import json

load_dotenv()
openai.api_key = os.getenv("OPENAI_API_KEY")
messages = []
flag = True
model_name = "gpt-3.5-turbo-0613"

functions = [
    {
        "name": "check_regex",
        "description": "æ­£è¦è¡¨ç¾ãŒæ­£ã—ã„ã‹ã©ã†ã‹ã‚’åˆ¤å®šã™ã‚‹é–¢æ•°ã€‚æˆ»ã‚Šå€¤ãŒTrueã®å ´åˆã¯æ­£è¦è¡¨ç¾ã¯æ­£ã—ã„ã¨åˆ¤æ–­ã™ã‚‹ã€Falseã®å ´åˆã¯æ­£ã—ããªã„ã¨åˆ¤æ–­ã™ã‚‹ã€‚",
        "parameters": {
            "type": "object",
            "properties": {
                "regex": {
                    "type": "string",
                    "description": "æ­£è¦è¡¨ç¾",
                },
                "test_strs": {
                    "type": "array",
                    "items": {"type": "string"},
                    "description": "ãƒ†ã‚¹ãƒˆã™ã‚‹æ–‡å­—åˆ—ã®é…åˆ—",
                },
                "result_with_test_strs": {
                    "type": "array",
                    "items": {"type": "boolean"},
                    "description": "ãƒ†ã‚¹ãƒˆã™ã‚‹æ–‡å­—åˆ—ã«å¯¾ã™ã‚‹æ¨å®šã—ã¦ã„ã‚‹çµæœã®é…åˆ—",
                },
            },
            "required": ["regex", "test_strs", "result_with_test_strs"],
        },
    }
]

# ä¸Šã§å®šç¾©ã—ãŸé–¢æ•°ã‚’å®Ÿè£…ã™ã‚‹

def check_regex(regex, test_strs, result_with_test_strs):
    import re

    result = []
    for test_str in test_strs:
        if re.match(regex, test_str):
            result.append(True)
        else:
            result.append(False)
    return result == result_with_test_strs


try:
    while True:
        if flag:
            question = input(">> ")
            if question == "exit":
                break
            messages.append({"role": "user", "content": question})
        else:
            flag = True
        responses = openai.ChatCompletion.create(
            model=model_name,
            messages=messages,
            functions=functions,
            # autoã«ã™ã‚‹ã¨è‡ªå‹•ã§é–¢æ•°ã‚’å‘¼ã¶ã‹ã©ã†ã‹ã‚’åˆ¤æ–­ã—ã¦ãã‚Œã‚‹
            function_call="auto",
        )
        message_tmp = responses["choices"][0]["message"]
        # function_callãŒã‚ã‚‹å ´åˆã¯é–¢æ•°ã‚’å‘¼ã³å‡ºã™
        if message_tmp.get("function_call"):
            try:
                arguments = json.loads(message_tmp["function_call"]["arguments"])
            except json.decoder.JSONDecodeError:
                flag = False
                continue
            function_response = check_regex(
                regex=arguments["regex"],
                test_strs=arguments["test_strs"],
                result_with_test_strs=arguments["result_with_test_strs"],
            )
            if function_response:
                print(
                    arguments["regex"],
                    arguments["test_strs"],
                    arguments["result_with_test_strs"],
                )
                flag = True
            messages.append(
                {
                    "role": "function",
                    "name": message_tmp["function_call"]["name"],
                    "content": str(function_response),
                }
            )

            if not function_response:
                messages.append(
                    {
                        "role": "user",
                        "content": "æ­£è¦è¡¨ç¾ãŒé–“é•ã£ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚ã‚‚ã†ä¸€åº¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚",
                    }
                )
                flag = False
        else:
            messages.append({"role": "assistant", "content": message_tmp["content"]})
            messages.append({"role": "user", "content": "testã—ã¦"})
            flag = False
except KeyboardInterrupt:
    pass
```

## ã¾ã¨ã‚

ä»Šå›ã¯ChatGPTã‚’ä½¿ã£ã¦æ­£è¦è¡¨ç¾ã®ç”Ÿæˆã‚’è©¦ã—ã¦ã¿ã¾ã—ãŸã€‚
Function callingã‚’ä½¿ã†ã“ã¨ã§ã€å®Ÿè£…ã¯ç°¡å˜ã«ã€å‹•ä½œã¯å®‰å®šã¨ã„ã†è‰¯ã„ã¨ã“å–ã‚ŠãŒã§ãã¾ã—ãŸã€‚
